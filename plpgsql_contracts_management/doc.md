# Документация системы управления договорами и комментариями

## Обзор системы
Система предназначена для управления договорами и комментариями к ним. Она включает две основные таблицы, представления для аналитики и функции для работы с комментариями.

## Структура базы данных

### 1. Последовательности
- **contracts_id_seq**  
  Параметры: Начинается с 1, шаг 1, без кэширования и циклов.
  
- **contract_comment_id_seq**  
  Параметры: Начинается с 1, шаг 1, без кэширования и циклов.

### 2. Таблицы

#### CONTRACTS
Основная таблица для хранения информации о договорах.

| Поле             | Тип            | Описание                                     |
|------------------|----------------|----------------------------------------------|
| contractid       | SERIAL (PK)    | Уникальный идентификатор договора            |
| contract_date    | DATE (NOT NULL) | Дата договора                                |
| phone_number     | VARCHAR(15)    | Номер телефона клиента                       |
| date_created      | TIMESTAMP      | Дата создания записи                         |
| user_created      | VARCHAR(50)    | Пользователь, создавший запись              |
| date_updated      | TIMESTAMP      | Дата последнего обновления                   |
| user_updated      | VARCHAR(50)    | Пользователь, обновивший запись             |
| **CONSTRAINT** check_ph_num | CHECK (phone_number ~ '^[0-9]{3,15}$') | Проверка формата номера телефона |

#### CONTRACT_COMMENT
Таблица для хранения комментариев к договорам.

| Поле               | Тип             | Описание                                     |
|--------------------|-----------------|----------------------------------------------|
| commid             | SERIAL (PK)     | Уникальный идентификатор комментария         |
| contractid         | INTEGER (FK)    | Ссылка на договор                            |
| comment_text       | VARCHAR(4000)   | Текст комментария                           |
| comm_date_created  | TIMESTAMP       | Дата создания комментария                    |
| comm_user_created  | VARCHAR(50)     | Пользователь, создавший комментарий         |
| comm_date_updated  | TIMESTAMP       | Дата последнего обновления                   |
| comm_user_updated  | VARCHAR(50)     | Пользователь, обновивший комментарий        |

### 3. Триггеры
- **trg_set_contracts**  
  Автоматическое заполнение служебных полей при `INSERT`/`UPDATE`:
  - При `INSERT`: устанавливает дату создания и пользователя.
  - При `INSERT`/`UPDATE`: обновляет дату и пользователя изменения.

- **trg_set_contract_comment**  
  Автоматическое заполнение служебных полей для комментариев (аналогично триггеру для договоров).

### 4. Представления
- **view_comments_info**  
  Отображает комментарии с информацией о договорах.

- **view_comments_this_week**  
  Комментарии к договорам, созданным на текущей неделе.

- **view_comments_count**  
  Количество комментариев по каждому договору.

- **view_comments_by_user**  
  Комментарии к договорам, созданным пользователями с фамилией, оканчивающейся на «ков».

### 5. Схема contract_comment_pkg
- **add_comment(contractid, comment_text)**  
  Добавление нового комментария к договору.  
  **Параметры:**
  - `contractid` (INTEGER) – ID договора.
  - `comment_text` (VARCHAR(4000)) – Текст комментария.

- **update_comment(p_commid, p_comment_text)**  
  Обновление существующего комментария.  
  **Параметры:**
  - `p_commid` (INTEGER) – ID комментария.
  - `p_comment_text` (VARCHAR(4000)) – Новый текст комментария.

- **delete_comment(p_commid)**  
  Удаление комментария.  
  **Параметры:**
  - `p_commid` (INTEGER) – ID комментария для удаления.

- **count_contracts_with_multiple_comments()**  
  Подсчет договоров с 2 и более комментариями за текущую неделю.  
  Возвращает `INTEGER` – количество договоров.
  - Учитывает только комментарии, созданные с начала текущей недели (активная версия).
  - Произвольный период (раскомментировать, если актуален такой вариант).

## Возможные улучшения
- Добавление ограничений на формат номера телефона.
- Использование TEXT для длинных комментариев.
- Реализация версии функции с параметрами дат.

---

**P.S. Спасибо за внимание, если вы дочитали до сюда!**
