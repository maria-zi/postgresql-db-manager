# Документация системы управления договорами и комментариями
---

## Обзор системы

Система предназначена для управления договорами и комментариями к ним. Включает в себя две основные таблицы, представления для аналитики и пакет процедур для работы с комментариями.

---

## Структура базы данных

### 1. Последовательности

- **contracts_id_seq**  
  Параметры: Начинается с 1, шаг 1, без кэширования и циклов.

- **contract_comment_id_seq**  
  Параметры: Начинается с 1, шаг 1, без кэширования и циклов.

### 2. Таблицы

#### CONTRACTS
Основная таблица договоров.

| Поле             | Тип            | Описание                                     |
|------------------|----------------|----------------------------------------------|
| contractid       | NUMBER (PK)    | Уникальный идентификатор договора            |
| contract_date    | DATE (NOT NULL) | Дата договора                                |
| phone_number     | VARCHAR2(15)   | Номер телефона клиента                       |
| date_created     | TIMESTAMP      | Дата создания записи                         |
| user_created      | VARCHAR2(50)   | Пользователь, создавший запись              |
| date_updated     | TIMESTAMP      | Дата последнего обновления                   |
| user_updated      | VARCHAR2(50)   | Пользователь, обновивший запись             |

#### CONTRACT_COMMENT
Таблица комментариев к договорам.

| Поле               | Тип             | Описание                                     |
|--------------------|-----------------|----------------------------------------------|
| commid             | NUMBER (PK)     | Уникальный идентификатор комментария         |
| contractid         | NUMBER (FK)     | Ссылка на договор                            |
| comment_text       | VARCHAR2(4000)  | Текст комментария                           |
| comm_date_created  | TIMESTAMP       | Дата создания комментария                    |
| comm_user_created  | VARCHAR2(50)    | Пользователь, создавший комментарий         |
| comm_date_updated  | TIMESTAMP       | Дата последнего обновления                   |
| comm_user_updated  | VARCHAR2(50)    | Пользователь, обновивший комментарий        |

### 3. Триггеры

- **trg_set_contracts**  
  Автоматическое заполнение служебных полей при `INSERT`/`UPDATE`:
  1. При `INSERT`: устанавливает ID, дату создания и пользователя.
  2. При `INSERT`/`UPDATE`: обновляет дату и пользователя изменения.

- **trg_set_contract_comment**  
  Автоматическое заполнение служебных полей комментариев (аналогично триггеру для договоров).

### 4. Представления

- **view_comments_info**  
  Отображение комментариев с информацией о договорах.

- **view_comments_this_week**  
  Комментарии к договорам, созданным на текущей неделе.

- **view_comments_count**  
  Количество комментариев по каждому договору.

- **view_comments_by_user**  
  Комментарии к договорам, созданным пользователями с фамилией на "ков".

### 5. Пакет процедур `contract_comment_pkg`

#### Процедуры

- **add_comment(contractid, comment_text)**  
  Добавление нового комментария к договору.  
  **Параметры:**
  - `contractid` (NUMBER) - ID договора.
  - `comment_text` (VARCHAR2) - Текст комментария.

- **update_comment(p_commid, p_comment_text)**  
  Обновление существующего комментария.  
  **Параметры:**
  - `p_commid` (NUMBER) - ID комментария.
  - `p_comment_text` (VARCHAR2) - Новый текст комментария.

- **delete_comment(p_commid)**  
  Удаление комментария.  
  **Параметры:**
  - `p_commid` (NUMBER) - ID комментария для удаления.

#### Функции

- **count_contracts_with_multiple_comments()**  
  Подсчет договоров с 2 и более комментариями за текущую неделю.  
  Возвращает `NUMBER` - количество договоров.
  1. Учитывает только комментарии, созданные с начала текущей недели (активная версия).
  2. Произвольный период (раскомментировать, если актуален такой вариант).

---

## Возможные улучшения

- Добавление ограничений на формат номера телефона.
- Использование `CLOB` для длинных комментариев.
- Реализация версии функции с параметрами дат.

---

**P.S. Спасибо за внимание, если Вы дочитали до сюда)**
